---
title: 缓存银弹
categories: 
- web
tags:
---

#缓存银弹

缓存对于读服务来说可谓抗流量的银弹。

## 1、浏览器端缓存
设置请求的过期时间，如响应头Expires、Cache-control进行控制。这种机制适用于如对实时性不太敏感的数据，
如商品详情页框架、商家评分、评价、广告词等；但对于如价格、库存等实时要求比较高的，就不能做浏览器端缓存。

## 2、CDN缓存
有些页面/活动页/图片等服务可以考虑将页面/活动页/图片推送到离用户最近的CDN节点让用户能在离他最近的节点找到想要的数据。
一般有两种机制：
推送机制（当内容变更后主动推送到CDN边缘节点）
拉取机制（先访问边缘节点，当没有内容时回源到源服务器拿到内容并存储到节点上），两种方式各有利弊。 
使用CDN时要考虑URL的设计，比如URL中不能有随机数，否则每次都穿透CDN，回源到源服务器，相当于CDN没有任何效果。
对于爬虫可以返回过期数据而选择不回源。

## 3、接入层缓存
对于没有CDN缓存的应用来说，可以考虑使用如Nginx搭建一层接入层，该接入层可以考虑如下机制实现：
1、URL重写：将URL按照指定的顺序或者格式重写，去除随机数；
2、一致性哈希：按照指定的参数（如分类/商品编号）做一致性Hash，从而保证相同数据落到一台服务器上；
3、proxy_cache：使用内存级/SSD级代理缓存来缓存内容；
4、proxy_cache_lock：使用lock机制，将多个回源合并为一个，减少回源量，并设置相应的lock超时时间；
5、shared_dict：此处如果架构使用了nginx+lua实现，可以考虑使用lua shared_dict进行cache，最大的好处就是reload缓存不丢失。
此处要注意，对于托底/异常数据不应该让其缓存，否则用户会在很长一段时间看到这些数据。

## 4、应用层缓存
如我们使用Tomcat时可以使用堆内缓存/堆外缓存，堆内缓存的最大问题就是重启时内存中的缓存丢失，
如果此时流量风暴来临可能冲垮应用；还可以考虑使用local redis cache来代替堆外内存；
或者在接入层使用shared_dict来将缓存前置，减少风暴。

## 5、分布式缓存
一种机制就是废弃分布式缓存，改成应用local redis cache，即在应用所在服务器中部署一个redis，然后使用主从机制同步数据。
如果数据量不大这种架构是最优的；如果数据量太大，单服务器存储不了，还可以考虑分片机制将流量分散到多台；
或者直接就是分布式缓存实现。常见的分片规则就是一致性哈希了。
<div align="center"> <img src="/images/分布式缓存.png"/> </div><br>


如上图就是我们一个应用的架构：
1、首先接入层读取本地proxy cache / local cache；
2、如果不命中，会读取分布式redis集群；
3、如果还不命中，会回源到tomcat，然后读取堆内cache；如果没有，则直接调用依赖业务获取数据；然后异步化写到redis集群；

因为我们使用了nginx+lua，第二、三步可以使用lua-resty-lock非阻塞锁减少峰值时的回源量；
如果你的服务是用户维度的，这种非阻塞锁不会有什么大作用。